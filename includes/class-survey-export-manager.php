<?php
/**
 * TPAK DQ System - Survey Export Manager
 * 
 * ระบบส่งออกและส่งต่อข้อมูลแบบสอบถามครบถ้วน
 * รองรับ PDF, Excel, JSON, Email และ API forwarding
 */

if (!defined('ABSPATH')) {
    exit;
}

class TPAK_Survey_Export_Manager {
    
    private static $instance = null;
    
    public static function getInstance() {
        if (self::$instance === null) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    public function __construct() {
        // AJAX handlers
        add_action('wp_ajax_export_survey_pdf', array($this, 'export_pdf'));
        add_action('wp_ajax_export_survey_excel', array($this, 'export_excel'));
        add_action('wp_ajax_export_survey_json', array($this, 'export_json'));
        add_action('wp_ajax_send_survey_email', array($this, 'send_email'));
        add_action('wp_ajax_bulk_export_surveys', array($this, 'bulk_export'));
        
        // WP Cron สำหรับ scheduled exports
        add_action('tpak_scheduled_export', array($this, 'handle_scheduled_export'));
    }
    
    /**
     * Export แบบสอบถามเป็น PDF พร้อมกราฟและตาราง
     */
    public function export_pdf() {
        check_ajax_referer('export_pdf_nonce', 'nonce');
        
        if (!current_user_can('export_survey_responses')) {
            wp_send_json_error('ไม่มีสิทธิ์ในการ Export');
        }
        
        $response_id = sanitize_text_field($_POST['response_id']);
        $include_charts = isset($_POST['include_charts']) && $_POST['include_charts'] === 'true';
        $include_history = isset($_POST['include_history']) && $_POST['include_history'] === 'true';
        $template = sanitize_text_field($_POST['template'] ?? 'standard');
        
        try {
            // ดึงข้อมูลสมบูรณ์
            $survey_data = $this->get_complete_survey_data($response_id);
            if (!$survey_data) {
                wp_send_json_error('ไม่พบข้อมูลแบบสอบถาม');
            }
            
            // สร้าง PDF
            $pdf_url = $this->generate_pdf($survey_data, array(
                'include_charts' => $include_charts,
                'include_history' => $include_history,
                'template' => $template
            ));
            
            // บันทึก log
            $this->log_export($response_id, 'pdf', $pdf_url);
            
            wp_send_json_success(array(
                'file_url' => $pdf_url,
                'message' => 'Export PDF เรียบร้อย',
                'file_name' => basename($pdf_url)
            ));
            
        } catch (Exception $e) {
            wp_send_json_error('เกิดข้อผิดพลาด: ' . $e->getMessage());
        }
    }
    
    /**
     * Export แบบสอบถามเป็น Excel พร้อมข้อมูลวิเคราะห์
     */
    public function export_excel() {
        check_ajax_referer('export_excel_nonce', 'nonce');
        
        if (!current_user_can('export_survey_responses')) {
            wp_send_json_error('ไม่มีสิทธิ์ในการ Export');
        }
        
        $response_id = sanitize_text_field($_POST['response_id']);
        $include_analysis = isset($_POST['include_analysis']) && $_POST['include_analysis'] === 'true';
        $format = sanitize_text_field($_POST['format'] ?? 'xlsx');
        
        try {
            // ดึงข้อมูลสมบูรณ์
            $survey_data = $this->get_complete_survey_data($response_id);
            if (!$survey_data) {
                wp_send_json_error('ไม่พบข้อมูลแบบสอบถาม');
            }
            
            // สร้าง Excel
            $excel_url = $this->generate_excel($survey_data, array(
                'include_analysis' => $include_analysis,
                'format' => $format\n            ));\n            \n            // บันทึก log\n            $this->log_export($response_id, 'excel', $excel_url);\n            \n            wp_send_json_success(array(\n                'file_url' => $excel_url,\n                'message' => 'Export Excel เรียบร้อย',\n                'file_name' => basename($excel_url)\n            ));\n            \n        } catch (Exception $e) {\n            wp_send_json_error('เกิดข้อผิดพลาด: ' . $e->getMessage());\n        }\n    }\n    \n    /**\n     * Export แบบสอบถามเป็น JSON\n     */\n    public function export_json() {\n        check_ajax_referer('export_json_nonce', 'nonce');\n        \n        if (!current_user_can('export_survey_responses')) {\n            wp_send_json_error('ไม่มีสิทธิ์ในการ Export');\n        }\n        \n        $response_id = sanitize_text_field($_POST['response_id']);\n        $pretty_print = isset($_POST['pretty_print']) && $_POST['pretty_print'] === 'true';\n        $include_metadata = isset($_POST['include_metadata']) && $_POST['include_metadata'] === 'true';\n        \n        try {\n            // ดึงข้อมูลสมบูรณ์\n            $survey_data = $this->get_complete_survey_data($response_id);\n            if (!$survey_data) {\n                wp_send_json_error('ไม่พบข้อมูลแบบสอบถาม');\n            }\n            \n            // สร้าง JSON\n            $json_url = $this->generate_json($survey_data, array(\n                'pretty_print' => $pretty_print,\n                'include_metadata' => $include_metadata\n            ));\n            \n            // บันทึก log\n            $this->log_export($response_id, 'json', $json_url);\n            \n            wp_send_json_success(array(\n                'file_url' => $json_url,\n                'message' => 'Export JSON เรียบร้อย',\n                'file_name' => basename($json_url)\n            ));\n            \n        } catch (Exception $e) {\n            wp_send_json_error('เกิดข้อผิดพลาด: ' . $e->getMessage());\n        }\n    }\n    \n    /**\n     * ส่งแบบสอบถามทาง Email\n     */\n    public function send_email() {\n        check_ajax_referer('send_email_nonce', 'nonce');\n        \n        if (!current_user_can('forward_survey_responses')) {\n            wp_send_json_error('ไม่มีสิทธิ์ในการส่ง Email');\n        }\n        \n        $response_id = sanitize_text_field($_POST['response_id']);\n        $recipients = array_map('sanitize_email', $_POST['recipients']);\n        $subject = sanitize_text_field($_POST['subject']);\n        $message = sanitize_textarea_field($_POST['message']);\n        $attach_pdf = isset($_POST['attach_pdf']) && $_POST['attach_pdf'] === 'true';\n        $attach_excel = isset($_POST['attach_excel']) && $_POST['attach_excel'] === 'true';\n        \n        try {\n            // ดึงข้อมูลสมบูรณ์\n            $survey_data = $this->get_complete_survey_data($response_id);\n            if (!$survey_data) {\n                wp_send_json_error('ไม่พบข้อมูลแบบสอบถาม');\n            }\n            \n            // เตรียม attachments\n            $attachments = array();\n            \n            if ($attach_pdf) {\n                $pdf_path = $this->generate_pdf($survey_data, array('template' => 'email'));\n                $attachments[] = str_replace(wp_upload_dir()['baseurl'], wp_upload_dir()['basedir'], $pdf_path);\n            }\n            \n            if ($attach_excel) {\n                $excel_path = $this->generate_excel($survey_data, array('format' => 'xlsx'));\n                $attachments[] = str_replace(wp_upload_dir()['baseurl'], wp_upload_dir()['basedir'], $excel_path);\n            }\n            \n            // ส่ง Email\n            $sent_count = 0;\n            $errors = array();\n            \n            foreach ($recipients as $email) {\n                if (empty($email)) continue;\n                \n                $personalized_message = $this->personalize_email_message($message, $email, $survey_data);\n                \n                $result = wp_mail(\n                    $email,\n                    $subject,\n                    $personalized_message,\n                    array('Content-Type: text/html; charset=UTF-8'),\n                    $attachments\n                );\n                \n                if ($result) {\n                    $sent_count++;\n                } else {\n                    $errors[] = $email;\n                }\n            }\n            \n            // บันทึก log\n            $this->log_export($response_id, 'email', array(\n                'recipients' => $recipients,\n                'sent_count' => $sent_count,\n                'errors' => $errors\n            ));\n            \n            wp_send_json_success(array(\n                'sent_count' => $sent_count,\n                'total_recipients' => count($recipients),\n                'errors' => $errors,\n                'message' => \"ส่ง Email สำเร็จ $sent_count จาก \" . count($recipients) . \" ผู้รับ\"\n            ));\n            \n        } catch (Exception $e) {\n            wp_send_json_error('เกิดข้อผิดพลาด: ' . $e->getMessage());\n        }\n    }\n    \n    /**\n     * Bulk export หลายแบบสอบถาม\n     */\n    public function bulk_export() {\n        check_ajax_referer('bulk_export_nonce', 'nonce');\n        \n        if (!current_user_can('export_survey_responses')) {\n            wp_send_json_error('ไม่มีสิทธิ์ในการ Export');\n        }\n        \n        $response_ids = array_map('sanitize_text_field', $_POST['response_ids']);\n        $export_format = sanitize_text_field($_POST['export_format']);\n        $merge_files = isset($_POST['merge_files']) && $_POST['merge_files'] === 'true';\n        \n        try {\n            $exported_files = array();\n            $errors = array();\n            \n            if ($merge_files) {\n                // รวมไฟล์เป็นไฟล์เดียว\n                $merged_data = array();\n                \n                foreach ($response_ids as $response_id) {\n                    $survey_data = $this->get_complete_survey_data($response_id);\n                    if ($survey_data) {\n                        $merged_data[] = $survey_data;\n                    } else {\n                        $errors[] = $response_id;\n                    }\n                }\n                \n                if (!empty($merged_data)) {\n                    $file_url = $this->generate_merged_export($merged_data, $export_format);\n                    $exported_files[] = $file_url;\n                }\n                \n            } else {\n                // Export แยกไฟล์\n                foreach ($response_ids as $response_id) {\n                    $survey_data = $this->get_complete_survey_data($response_id);\n                    \n                    if ($survey_data) {\n                        switch ($export_format) {\n                            case 'pdf':\n                                $file_url = $this->generate_pdf($survey_data);\n                                break;\n                            case 'excel':\n                                $file_url = $this->generate_excel($survey_data);\n                                break;\n                            case 'json':\n                                $file_url = $this->generate_json($survey_data);\n                                break;\n                            default:\n                                throw new Exception('รูปแบบไฟล์ไม่ถูกต้อง');\n                        }\n                        \n                        $exported_files[] = $file_url;\n                        \n                    } else {\n                        $errors[] = $response_id;\n                    }\n                }\n            }\n            \n            // สร้าง ZIP ถ้ามีหลายไฟล์\n            if (count($exported_files) > 1) {\n                $zip_url = $this->create_zip_archive($exported_files, 'bulk_export_' . time());\n                $exported_files = array($zip_url);\n            }\n            \n            // บันทึก log\n            $this->log_export('bulk_' . implode(',', $response_ids), $export_format, $exported_files);\n            \n            wp_send_json_success(array(\n                'exported_files' => $exported_files,\n                'total_processed' => count($response_ids),\n                'successful' => count($exported_files),\n                'errors' => $errors,\n                'message' => 'Bulk Export เรียบร้อย'\n            ));\n            \n        } catch (Exception $e) {\n            wp_send_json_error('เกิดข้อผิดพลาด: ' . $e->getMessage());\n        }\n    }\n    \n    /**\n     * สร้าง PDF จากข้อมูลแบบสอบถาม\n     */\n    private function generate_pdf($survey_data, $options = array()) {\n        // ใช้ TCPDF หรือ mPDF\n        require_once TPAK_DQ_SYSTEM_PLUGIN_DIR . 'libs/tcpdf/tcpdf.php';\n        \n        $pdf = new TCPDF('P', 'mm', 'A4', true, 'UTF-8', false);\n        \n        // ตั้งค่า PDF\n        $pdf->SetCreator('TPAK DQ System');\n        $pdf->SetAuthor('TPAK Survey System');\n        $pdf->SetTitle('Survey Report - ' . $survey_data['response_id']);\n        \n        // กำหนด font สำหรับภาษาไทย\n        $pdf->SetFont('thsarabunnew', '', 14);\n        \n        // Header และ Footer\n        $pdf->SetHeaderData('', 0, 'รายงานแบบสอบถาม', 'Response ID: ' . $survey_data['response_id']);\n        $pdf->setFooterData();\n        \n        // เพิ่มหน้า\n        $pdf->AddPage();\n        \n        // เนื้อหา PDF\n        $html = $this->generate_pdf_content($survey_data, $options);\n        $pdf->writeHTML($html, true, false, true, false, '');\n        \n        // สร้างไฟล์\n        $upload_dir = wp_upload_dir();\n        $file_name = 'survey_' . $survey_data['response_id'] . '_' . time() . '.pdf';\n        $file_path = $upload_dir['basedir'] . '/tpak-exports/' . $file_name;\n        \n        // สร้างโฟลเดอร์ถ้ายังไม่มี\n        wp_mkdir_p($upload_dir['basedir'] . '/tpak-exports/');\n        \n        // บันทึกไฟล์\n        $pdf->Output($file_path, 'F');\n        \n        return $upload_dir['baseurl'] . '/tpak-exports/' . $file_name;\n    }\n    \n    /**\n     * สร้าง Excel จากข้อมูลแบบสอบถาม\n     */\n    private function generate_excel($survey_data, $options = array()) {\n        // ใช้ PHPSpreadsheet\n        require_once TPAK_DQ_SYSTEM_PLUGIN_DIR . 'libs/phpspreadsheet/vendor/autoload.php';\n        \n        use PhpOffice\\PhpSpreadsheet\\Spreadsheet;\n        use PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\n        use PhpOffice\\PhpSpreadsheet\\Style\\Color;\n        use PhpOffice\\PhpSpreadsheet\\Style\\Fill;\n        \n        $spreadsheet = new Spreadsheet();\n        $sheet = $spreadsheet->getActiveSheet();\n        \n        // หัวข้อ\n        $sheet->setTitle('Survey Response');\n        $sheet->setCellValue('A1', 'รายงานแบบสอบถาม');\n        $sheet->setCellValue('A2', 'Response ID: ' . $survey_data['response_id']);\n        $sheet->setCellValue('A3', 'วันที่: ' . date('Y-m-d H:i:s'));\n        \n        // จัดรูปแบบหัวข้อ\n        $sheet->getStyle('A1')->getFont()->setBold(true)->setSize(16);\n        $sheet->getStyle('A2:A3')->getFont()->setSize(12);\n        \n        // ข้อมูลแบบสอบถาม\n        $row = 5;\n        $response_data = json_decode($survey_data['response_data'], true);\n        $responses = $response_data['responses'] ?? array();\n        \n        // หัวตาราง\n        $sheet->setCellValue('A' . $row, 'คำถาม');\n        $sheet->setCellValue('B' . $row, 'คำตอบ');\n        $sheet->setCellValue('C' . $row, 'ประเภท');\n        \n        // จัดรูปแบบหัวตาราง\n        $headerStyle = [\n            'font' => ['bold' => true],\n            'fill' => [\n                'fillType' => Fill::FILL_SOLID,\n                'startColor' => ['rgb' => 'E2EFDA']\n            ]\n        ];\n        $sheet->getStyle('A' . $row . ':C' . $row)->applyFromArray($headerStyle);\n        \n        $row++;\n        \n        // ข้อมูลคำตอบ\n        foreach ($responses as $field => $value) {\n            $question_text = $this->get_question_text($field, $survey_data);\n            $formatted_value = $this->format_answer_for_export($value);\n            $question_type = $this->get_question_type($field);\n            \n            $sheet->setCellValue('A' . $row, $question_text);\n            $sheet->setCellValue('B' . $row, $formatted_value);\n            $sheet->setCellValue('C' . $row, $question_type);\n            \n            $row++;\n        }\n        \n        // ปรับขนาดคอลัมน์\n        $sheet->getColumnDimension('A')->setWidth(50);\n        $sheet->getColumnDimension('B')->setWidth(30);\n        $sheet->getColumnDimension('C')->setWidth(15);\n        \n        // เพิ่ม sheet วิเคราะห์ถ้าต้องการ\n        if (isset($options['include_analysis']) && $options['include_analysis']) {\n            $this->add_analysis_sheet($spreadsheet, $survey_data);\n        }\n        \n        // บันทึกไฟล์\n        $upload_dir = wp_upload_dir();\n        $file_name = 'survey_' . $survey_data['response_id'] . '_' . time() . '.xlsx';\n        $file_path = $upload_dir['basedir'] . '/tpak-exports/' . $file_name;\n        \n        wp_mkdir_p($upload_dir['basedir'] . '/tpak-exports/');\n        \n        $writer = new Xlsx($spreadsheet);\n        $writer->save($file_path);\n        \n        return $upload_dir['baseurl'] . '/tpak-exports/' . $file_name;\n    }\n    \n    /**\n     * สร้าง JSON จากข้อมูลแบบสอบถาม\n     */\n    private function generate_json($survey_data, $options = array()) {\n        $export_data = $survey_data;\n        \n        // เพิ่ม metadata ถ้าต้องการ\n        if (isset($options['include_metadata']) && $options['include_metadata']) {\n            $export_data['export_metadata'] = array(\n                'exported_at' => current_time('mysql'),\n                'exported_by' => get_current_user_id(),\n                'export_version' => '1.0',\n                'system_info' => array(\n                    'plugin_version' => TPAK_DQ_SYSTEM_VERSION,\n                    'wordpress_version' => get_bloginfo('version'),\n                    'php_version' => PHP_VERSION\n                )\n            );\n        }\n        \n        // กำหนดรูปแบบ JSON\n        $json_flags = JSON_UNESCAPED_UNICODE;\n        if (isset($options['pretty_print']) && $options['pretty_print']) {\n            $json_flags |= JSON_PRETTY_PRINT;\n        }\n        \n        // บันทึกไฟล์\n        $upload_dir = wp_upload_dir();\n        $file_name = 'survey_' . $survey_data['response_id'] . '_' . time() . '.json';\n        $file_path = $upload_dir['basedir'] . '/tpak-exports/' . $file_name;\n        \n        wp_mkdir_p($upload_dir['basedir'] . '/tpak-exports/');\n        \n        file_put_contents($file_path, json_encode($export_data, $json_flags));\n        \n        return $upload_dir['baseurl'] . '/tpak-exports/' . $file_name;\n    }\n    \n    /**\n     * สร้าง ZIP archive\n     */\n    private function create_zip_archive($file_urls, $zip_name) {\n        $upload_dir = wp_upload_dir();\n        $zip_file_name = $zip_name . '.zip';\n        $zip_file_path = $upload_dir['basedir'] . '/tpak-exports/' . $zip_file_name;\n        \n        $zip = new ZipArchive();\n        \n        if ($zip->open($zip_file_path, ZipArchive::CREATE) === TRUE) {\n            foreach ($file_urls as $url) {\n                $file_path = str_replace($upload_dir['baseurl'], $upload_dir['basedir'], $url);\n                if (file_exists($file_path)) {\n                    $zip->addFile($file_path, basename($file_path));\n                }\n            }\n            $zip->close();\n            \n            return $upload_dir['baseurl'] . '/tpak-exports/' . $zip_file_name;\n        }\n        \n        throw new Exception('ไม่สามารถสร้างไฟล์ ZIP ได้');\n    }\n    \n    /**\n     * ดึงข้อมูลแบบสอบถามสมบูรณ์\n     */\n    private function get_complete_survey_data($response_id) {\n        global $wpdb;\n        $table_name = $wpdb->prefix . 'tpak_survey_responses';\n        \n        $data = $wpdb->get_row($wpdb->prepare(\n            \"SELECT * FROM $table_name WHERE response_id = %s\",\n            $response_id\n        ), ARRAY_A);\n        \n        if ($data) {\n            // เพิ่มข้อมูล survey structure\n            $response_data = json_decode($data['response_data'], true);\n            $survey_id = $data['survey_id'];\n            \n            // ดึง LSS structure\n            $lss_structure = get_option('tpak_lss_structure_' . $survey_id, false);\n            if ($lss_structure) {\n                $data['survey_structure'] = $lss_structure;\n            }\n            \n            // ดึง audit trail\n            $data['audit_trail'] = $this->get_audit_trail($response_id);\n            \n            return $data;\n        }\n        \n        return null;\n    }\n    \n    /**\n     * ดึง audit trail\n     */\n    private function get_audit_trail($response_id) {\n        global $wpdb;\n        $audit_table = $wpdb->prefix . 'tpak_survey_audit';\n        \n        return $wpdb->get_results($wpdb->prepare(\n            \"SELECT * FROM $audit_table \n             WHERE response_id = %s \n             ORDER BY created_at DESC\",\n            $response_id\n        ), ARRAY_A);\n    }\n    \n    /**\n     * สร้างเนื้อหา PDF\n     */\n    private function generate_pdf_content($survey_data, $options = array()) {\n        $html = '<style>\n            body { font-family: \"TH Sarabun New\", sans-serif; }\n            .header { text-align: center; margin-bottom: 20px; }\n            .question { margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; }\n            .question-title { font-weight: bold; color: #333; }\n            .answer { color: #666; margin-top: 5px; }\n            .modified { background-color: #fff3cd; }\n        </style>';\n        \n        $html .= '<div class=\"header\">';\n        $html .= '<h1>รายงานแบบสอบถาม</h1>';\n        $html .= '<p>Response ID: ' . esc_html($survey_data['response_id']) . '</p>';\n        $html .= '<p>วันที่สร้าง: ' . esc_html($survey_data['created_at']) . '</p>';\n        $html .= '</div>';\n        \n        $response_data = json_decode($survey_data['response_data'], true);\n        $responses = $response_data['responses'] ?? array();\n        $modifications = $response_data['modifications'] ?? array();\n        \n        $html .= '<div class=\"content\">';\n        \n        foreach ($responses as $field => $value) {\n            $question_text = $this->get_question_text($field, $survey_data);\n            $formatted_value = $this->format_answer_for_export($value);\n            $is_modified = $this->is_field_modified($field, $modifications);\n            \n            $html .= '<div class=\"question' . ($is_modified ? ' modified' : '') . '\">';\n            $html .= '<div class=\"question-title\">' . esc_html($question_text) . '</div>';\n            $html .= '<div class=\"answer\">' . esc_html($formatted_value) . '</div>';\n            \n            if ($is_modified) {\n                $html .= '<div class=\"modification-note\">* ข้อมูลนี้ได้รับการแก้ไข</div>';\n            }\n            \n            $html .= '</div>';\n        }\n        \n        $html .= '</div>';\n        \n        // เพิ่มประวัติการแก้ไขถ้าต้องการ\n        if (isset($options['include_history']) && $options['include_history'] && !empty($survey_data['audit_trail'])) {\n            $html .= '<div class=\"history\">';\n            $html .= '<h2>ประวัติการแก้ไข</h2>';\n            \n            foreach ($survey_data['audit_trail'] as $entry) {\n                $html .= '<div class=\"history-item\">';\n                $html .= '<strong>' . esc_html($entry['created_at']) . '</strong> - ';\n                $html .= esc_html($entry['action']) . ' โดย ' . esc_html($entry['user_name']);\n                $html .= '</div>';\n            }\n            \n            $html .= '</div>';\n        }\n        \n        return $html;\n    }\n    \n    /**\n     * เพิ่ม analysis sheet ใน Excel\n     */\n    private function add_analysis_sheet($spreadsheet, $survey_data) {\n        $analysisSheet = $spreadsheet->createSheet();\n        $analysisSheet->setTitle('Analysis');\n        \n        // TODO: เพิ่มการวิเคราะห์ข้อมูล\n        $analysisSheet->setCellValue('A1', 'การวิเคราะห์ข้อมูล');\n        $analysisSheet->setCellValue('A2', 'จำนวนคำถามทั้งหมด: ');\n        $analysisSheet->setCellValue('A3', 'จำนวนคำตอบที่กรอก: ');\n        $analysisSheet->setCellValue('A4', 'เปอร์เซ็นต์ความสมบูรณ์: ');\n    }\n    \n    /**\n     * Personalize email message\n     */\n    private function personalize_email_message($message, $email, $survey_data) {\n        $user = get_user_by('email', $email);\n        $display_name = $user ? $user->display_name : $email;\n        \n        $placeholders = array(\n            '{{name}}' => $display_name,\n            '{{response_id}}' => $survey_data['response_id'],\n            '{{survey_id}}' => $survey_data['survey_id'],\n            '{{date}}' => date('Y-m-d H:i:s')\n        );\n        \n        return str_replace(array_keys($placeholders), array_values($placeholders), $message);\n    }\n    \n    /**\n     * ดึงข้อความคำถาม\n     */\n    private function get_question_text($field, $survey_data) {\n        // ลองดึงจาก survey structure\n        if (isset($survey_data['survey_structure'])) {\n            $structure = $survey_data['survey_structure'];\n            $qid = str_replace('question_', '', $field);\n            \n            if (isset($structure['question_texts'][$qid])) {\n                return $structure['question_texts'][$qid]['question'];\n            }\n        }\n        \n        return $field;\n    }\n    \n    /**\n     * Format คำตอบสำหรับ export\n     */\n    private function format_answer_for_export($value) {\n        if (is_array($value)) {\n            return implode(', ', $value);\n        }\n        \n        // ใช้ Question Dictionary\n        require_once TPAK_DQ_SYSTEM_PLUGIN_DIR . 'includes/class-question-dictionary.php';\n        $dictionary = TPAK_Question_Dictionary::getInstance();\n        \n        $formatted = $dictionary->getAnswerText($value);\n        return $formatted !== $value ? $formatted : $value;\n    }\n    \n    /**\n     * ดึงประเภทคำถาม\n     */\n    private function get_question_type($field) {\n        // TODO: ดึงจาก survey structure\n        return 'text';\n    }\n    \n    /**\n     * ตรวจสอบว่าฟิลด์ถูกแก้ไขหรือไม่\n     */\n    private function is_field_modified($field, $modifications) {\n        foreach ($modifications as $mod) {\n            if ($mod['field'] === $field) {\n                return true;\n            }\n        }\n        return false;\n    }\n    \n    /**\n     * สร้าง merged export\n     */\n    private function generate_merged_export($merged_data, $format) {\n        switch ($format) {\n            case 'excel':\n                return $this->generate_merged_excel($merged_data);\n            case 'json':\n                return $this->generate_merged_json($merged_data);\n            default:\n                throw new Exception('รูปแบบ Merged Export ไม่ถูกต้อง');\n        }\n    }\n    \n    /**\n     * สร้าง merged Excel\n     */\n    private function generate_merged_excel($merged_data) {\n        // TODO: Implement merged Excel generation\n        return $this->generate_excel($merged_data[0]); // ตัวอย่าง\n    }\n    \n    /**\n     * สร้าง merged JSON\n     */\n    private function generate_merged_json($merged_data) {\n        $upload_dir = wp_upload_dir();\n        $file_name = 'merged_survey_' . time() . '.json';\n        $file_path = $upload_dir['basedir'] . '/tpak-exports/' . $file_name;\n        \n        wp_mkdir_p($upload_dir['basedir'] . '/tpak-exports/');\n        \n        file_put_contents($file_path, json_encode($merged_data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));\n        \n        return $upload_dir['baseurl'] . '/tpak-exports/' . $file_name;\n    }\n    \n    /**\n     * บันทึก export log\n     */\n    private function log_export($response_id, $format, $result) {\n        global $wpdb;\n        $current_user = wp_get_current_user();\n        \n        $wpdb->insert(\n            $wpdb->prefix . 'tpak_survey_audit',\n            array(\n                'response_id' => $response_id,\n                'action' => 'exported',\n                'action_data' => json_encode(array(\n                    'format' => $format,\n                    'result' => $result\n                )),\n                'user_id' => $current_user->ID,\n                'user_name' => $current_user->display_name,\n                'ip_address' => $_SERVER['REMOTE_ADDR'],\n                'user_agent' => $_SERVER['HTTP_USER_AGENT'],\n                'created_at' => current_time('mysql')\n            )\n        );\n    }\n    \n    /**\n     * Schedule export\n     */\n    public function schedule_export($response_id, $format, $schedule_time) {\n        wp_schedule_single_event(\n            $schedule_time,\n            'tpak_scheduled_export',\n            array($response_id, $format)\n        );\n    }\n    \n    /**\n     * Handle scheduled export\n     */\n    public function handle_scheduled_export($response_id, $format) {\n        $survey_data = $this->get_complete_survey_data($response_id);\n        \n        if ($survey_data) {\n            switch ($format) {\n                case 'pdf':\n                    $this->generate_pdf($survey_data);\n                    break;\n                case 'excel':\n                    $this->generate_excel($survey_data);\n                    break;\n                case 'json':\n                    $this->generate_json($survey_data);\n                    break;\n            }\n            \n            // ส่ง notification\n            $this->send_export_notification($response_id, $format);\n        }\n    }\n    \n    /**\n     * ส่ง export notification\n     */\n    private function send_export_notification($response_id, $format) {\n        // TODO: ส่ง email แจ้งเตือนเมื่อ export เสร็จ\n    }\n}