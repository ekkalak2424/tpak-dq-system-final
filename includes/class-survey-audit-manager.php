<?php
/**
 * TPAK DQ System - Survey Audit Manager
 * 
 * ระบบจัดการ Audit Log สำหรับการแก้ไขแบบสอบถาม
 * ติดตามการเปลี่ยนแปลงทุกครั้งพร้อมรายละเอียดสมบูรณ์
 */

if (!defined('ABSPATH')) {
    exit;
}

class TPAK_Survey_Audit_Manager {
    
    private static $instance = null;
    
    public static function getInstance() {
        if (self::$instance === null) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    public function __construct() {
        // สร้างตาราง audit เมื่อ activate plugin
        register_activation_hook(TPAK_DQ_SYSTEM_PLUGIN_FILE, array($this, 'create_audit_tables'));
        
        // AJAX handlers
        add_action('wp_ajax_get_audit_details', array($this, 'get_audit_details'));
        add_action('wp_ajax_get_audit_summary', array($this, 'get_audit_summary'));
        add_action('wp_ajax_export_audit_log', array($this, 'export_audit_log'));
        add_action('wp_ajax_compare_versions', array($this, 'compare_versions'));
        add_action('wp_ajax_restore_version', array($this, 'restore_version'));
        
        // Auto-cleanup old logs
        add_action('tpak_cleanup_audit_logs', array($this, 'cleanup_old_logs'));
        
        // Schedule cleanup
        if (!wp_next_scheduled('tpak_cleanup_audit_logs')) {
            wp_schedule_event(time(), 'daily', 'tpak_cleanup_audit_logs');
        }
    }
    
    /**
     * สร้างตาราง audit logs
     */
    public function create_audit_tables() {
        global $wpdb;\n        $charset_collate = $wpdb->get_charset_collate();\n        \n        // ตาราง audit หลัก\n        $table_audit = $wpdb->prefix . 'tpak_survey_audit';\n        $sql_audit = \"CREATE TABLE IF NOT EXISTS $table_audit (\n            id bigint(20) NOT NULL AUTO_INCREMENT,\n            response_id varchar(100) NOT NULL,\n            action varchar(50) NOT NULL,\n            action_data longtext,\n            field_changes longtext,\n            before_data longtext,\n            after_data longtext,\n            user_id bigint(20),\n            user_name varchar(100),\n            user_role varchar(50),\n            ip_address varchar(45),\n            user_agent text,\n            session_id varchar(100),\n            request_uri varchar(500),\n            severity enum('low', 'medium', 'high', 'critical') DEFAULT 'low',\n            status enum('success', 'failed', 'pending') DEFAULT 'success',\n            created_at datetime DEFAULT CURRENT_TIMESTAMP,\n            PRIMARY KEY (id),\n            KEY response_id (response_id),\n            KEY action (action),\n            KEY user_id (user_id),\n            KEY created_at (created_at),\n            KEY severity (severity),\n            KEY status (status)\n        ) $charset_collate;\";\n        \n        // ตาราง field changes รายละเอียด\n        $table_field_changes = $wpdb->prefix . 'tpak_survey_field_changes';\n        $sql_field_changes = \"CREATE TABLE IF NOT EXISTS $table_field_changes (\n            id bigint(20) NOT NULL AUTO_INCREMENT,\n            audit_id bigint(20) NOT NULL,\n            response_id varchar(100) NOT NULL,\n            field_name varchar(100) NOT NULL,\n            field_type varchar(50),\n            old_value text,\n            new_value text,\n            change_type enum('created', 'updated', 'deleted') DEFAULT 'updated',\n            validation_status enum('valid', 'invalid', 'warning') DEFAULT 'valid',\n            validation_message text,\n            created_at datetime DEFAULT CURRENT_TIMESTAMP,\n            PRIMARY KEY (id),\n            KEY audit_id (audit_id),\n            KEY response_id (response_id),\n            KEY field_name (field_name),\n            KEY change_type (change_type),\n            FOREIGN KEY (audit_id) REFERENCES $table_audit(id) ON DELETE CASCADE\n        ) $charset_collate;\";\n        \n        // ตาราง user sessions\n        $table_sessions = $wpdb->prefix . 'tpak_user_sessions';\n        $sql_sessions = \"CREATE TABLE IF NOT EXISTS $table_sessions (\n            id bigint(20) NOT NULL AUTO_INCREMENT,\n            session_id varchar(100) NOT NULL,\n            user_id bigint(20) NOT NULL,\n            login_time datetime DEFAULT CURRENT_TIMESTAMP,\n            last_activity datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n            ip_address varchar(45),\n            user_agent text,\n            is_active tinyint(1) DEFAULT 1,\n            logout_time datetime,\n            session_data longtext,\n            PRIMARY KEY (id),\n            UNIQUE KEY session_id (session_id),\n            KEY user_id (user_id),\n            KEY is_active (is_active)\n        ) $charset_collate;\";\n        \n        require_once(ABSPATH . 'wp-admin/includes/upgrade.php');\n        dbDelta($sql_audit);\n        dbDelta($sql_field_changes);\n        dbDelta($sql_sessions);\n    }\n    \n    /**\n     * บันทึก audit log รายละเอียดสมบูรณ์\n     */\n    public function log_audit($response_id, $action, $data = array()) {\n        global $wpdb;\n        $current_user = wp_get_current_user();\n        $session_id = $this->get_or_create_session();\n        \n        // วิเคราะห์ความสำคัญของ action\n        $severity = $this->get_action_severity($action);\n        \n        // เตรียมข้อมูล audit\n        $audit_data = array(\n            'response_id' => $response_id,\n            'action' => $action,\n            'action_data' => json_encode($data, JSON_UNESCAPED_UNICODE),\n            'user_id' => $current_user->ID,\n            'user_name' => $current_user->display_name,\n            'user_role' => implode(', ', $current_user->roles),\n            'ip_address' => $this->get_client_ip(),\n            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',\n            'session_id' => $session_id,\n            'request_uri' => $_SERVER['REQUEST_URI'] ?? '',\n            'severity' => $severity,\n            'status' => 'success',\n            'created_at' => current_time('mysql')\n        );\n        \n        // บันทึกข้อมูล before/after ถ้ามี\n        if (isset($data['before_data'])) {\n            $audit_data['before_data'] = json_encode($data['before_data'], JSON_UNESCAPED_UNICODE);\n        }\n        \n        if (isset($data['after_data'])) {\n            $audit_data['after_data'] = json_encode($data['after_data'], JSON_UNESCAPED_UNICODE);\n        }\n        \n        // บันทึก field changes\n        if (isset($data['field_changes'])) {\n            $audit_data['field_changes'] = json_encode($data['field_changes'], JSON_UNESCAPED_UNICODE);\n        }\n        \n        // บันทึกลงฐานข้อมูล\n        $result = $wpdb->insert(\n            $wpdb->prefix . 'tpak_survey_audit',\n            $audit_data\n        );\n        \n        if ($result) {\n            $audit_id = $wpdb->insert_id;\n            \n            // บันทึก field changes รายละเอียด\n            if (isset($data['field_changes']) && is_array($data['field_changes'])) {\n                $this->log_field_changes($audit_id, $response_id, $data['field_changes']);\n            }\n            \n            // อัปเดต session activity\n            $this->update_session_activity($session_id);\n            \n            return $audit_id;\n        }\n        \n        return false;\n    }\n    \n    /**\n     * บันทึก field changes รายละเอียด\n     */\n    private function log_field_changes($audit_id, $response_id, $field_changes) {\n        global $wpdb;\n        \n        foreach ($field_changes as $change) {\n            $change_data = array(\n                'audit_id' => $audit_id,\n                'response_id' => $response_id,\n                'field_name' => $change['field'],\n                'field_type' => $change['type'] ?? 'text',\n                'old_value' => $change['old_value'],\n                'new_value' => $change['new_value'],\n                'change_type' => $this->determine_change_type($change['old_value'], $change['new_value']),\n                'validation_status' => $change['validation_status'] ?? 'valid',\n                'validation_message' => $change['validation_message'] ?? '',\n                'created_at' => current_time('mysql')\n            );\n            \n            $wpdb->insert(\n                $wpdb->prefix . 'tpak_survey_field_changes',\n                $change_data\n            );\n        }\n    }\n    \n    /**\n     * ดึงรายละเอียด audit\n     */\n    public function get_audit_details() {\n        check_ajax_referer('audit_details_nonce', 'nonce');\n        \n        if (!current_user_can('review_survey_responses')) {\n            wp_send_json_error('ไม่มีสิทธิ์ในการดู Audit Log');\n        }\n        \n        $response_id = sanitize_text_field($_POST['response_id']);\n        $limit = intval($_POST['limit'] ?? 50);\n        $offset = intval($_POST['offset'] ?? 0);\n        \n        global $wpdb;\n        $audit_table = $wpdb->prefix . 'tpak_survey_audit';\n        $field_changes_table = $wpdb->prefix . 'tpak_survey_field_changes';\n        \n        // ดึงข้อมูล audit หลัก\n        $audits = $wpdb->get_results($wpdb->prepare(\n            \"SELECT * FROM $audit_table \n             WHERE response_id = %s \n             ORDER BY created_at DESC \n             LIMIT %d OFFSET %d\",\n            $response_id, $limit, $offset\n        ), ARRAY_A);\n        \n        // เพิ่มข้อมูล field changes\n        foreach ($audits as &$audit) {\n            $field_changes = $wpdb->get_results($wpdb->prepare(\n                \"SELECT * FROM $field_changes_table \n                 WHERE audit_id = %d \n                 ORDER BY field_name\",\n                $audit['id']\n            ), ARRAY_A);\n            \n            $audit['field_changes_detail'] = $field_changes;\n            $audit['action_data'] = json_decode($audit['action_data'], true);\n            $audit['before_data'] = json_decode($audit['before_data'], true);\n            $audit['after_data'] = json_decode($audit['after_data'], true);\n        }\n        \n        // นับจำนวนทั้งหมด\n        $total = $wpdb->get_var($wpdb->prepare(\n            \"SELECT COUNT(*) FROM $audit_table WHERE response_id = %s\",\n            $response_id\n        ));\n        \n        wp_send_json_success(array(\n            'audits' => $audits,\n            'total' => $total,\n            'has_more' => ($offset + $limit) < $total\n        ));\n    }\n    \n    /**\n     * ดึงสรุป audit\n     */\n    public function get_audit_summary() {\n        check_ajax_referer('audit_summary_nonce', 'nonce');\n        \n        if (!current_user_can('review_survey_responses')) {\n            wp_send_json_error('ไม่มีสิทธิ์ในการดู Audit Summary');\n        }\n        \n        $response_id = sanitize_text_field($_POST['response_id']);\n        $days = intval($_POST['days'] ?? 30);\n        \n        global $wpdb;\n        $audit_table = $wpdb->prefix . 'tpak_survey_audit';\n        \n        // สถิติการแก้ไข\n        $edit_stats = $wpdb->get_results($wpdb->prepare(\n            \"SELECT \n                action,\n                COUNT(*) as count,\n                DATE(created_at) as date\n             FROM $audit_table \n             WHERE response_id = %s \n               AND created_at >= DATE_SUB(NOW(), INTERVAL %d DAY)\n             GROUP BY action, DATE(created_at)\n             ORDER BY created_at DESC\",\n            $response_id, $days\n        ), ARRAY_A);\n        \n        // ผู้ใช้ที่แก้ไข\n        $user_stats = $wpdb->get_results($wpdb->prepare(\n            \"SELECT \n                user_name,\n                user_role,\n                COUNT(*) as edit_count,\n                MAX(created_at) as last_edit\n             FROM $audit_table \n             WHERE response_id = %s \n               AND created_at >= DATE_SUB(NOW(), INTERVAL %d DAY)\n             GROUP BY user_id, user_name, user_role\n             ORDER BY edit_count DESC\",\n            $response_id, $days\n        ), ARRAY_A);\n        \n        // สถิติ severity\n        $severity_stats = $wpdb->get_results($wpdb->prepare(\n            \"SELECT \n                severity,\n                COUNT(*) as count\n             FROM $audit_table \n             WHERE response_id = %s \n               AND created_at >= DATE_SUB(NOW(), INTERVAL %d DAY)\n             GROUP BY severity\",\n            $response_id, $days\n        ), ARRAY_A);\n        \n        // Field ที่แก้ไขบ่อยที่สุด\n        $field_changes_table = $wpdb->prefix . 'tpak_survey_field_changes';\n        $field_stats = $wpdb->get_results($wpdb->prepare(\n            \"SELECT \n                fc.field_name,\n                fc.field_type,\n                COUNT(*) as change_count\n             FROM $field_changes_table fc\n             JOIN $audit_table a ON fc.audit_id = a.id\n             WHERE fc.response_id = %s \n               AND a.created_at >= DATE_SUB(NOW(), INTERVAL %d DAY)\n             GROUP BY fc.field_name, fc.field_type\n             ORDER BY change_count DESC\n             LIMIT 10\",\n            $response_id, $days\n        ), ARRAY_A);\n        \n        wp_send_json_success(array(\n            'edit_stats' => $edit_stats,\n            'user_stats' => $user_stats,\n            'severity_stats' => $severity_stats,\n            'field_stats' => $field_stats,\n            'period_days' => $days\n        ));\n    }\n    \n    /**\n     * Export audit log\n     */\n    public function export_audit_log() {\n        check_ajax_referer('export_audit_nonce', 'nonce');\n        \n        if (!current_user_can('export_survey_responses')) {\n            wp_send_json_error('ไม่มีสิทธิ์ในการ Export Audit Log');\n        }\n        \n        $response_id = sanitize_text_field($_POST['response_id']);\n        $format = sanitize_text_field($_POST['format'] ?? 'excel');\n        $date_from = sanitize_text_field($_POST['date_from'] ?? '');\n        $date_to = sanitize_text_field($_POST['date_to'] ?? '');\n        \n        try {\n            $audit_data = $this->get_audit_export_data($response_id, $date_from, $date_to);\n            \n            switch ($format) {\n                case 'excel':\n                    $file_url = $this->export_audit_to_excel($audit_data, $response_id);\n                    break;\n                case 'json':\n                    $file_url = $this->export_audit_to_json($audit_data, $response_id);\n                    break;\n                case 'csv':\n                    $file_url = $this->export_audit_to_csv($audit_data, $response_id);\n                    break;\n                default:\n                    throw new Exception('รูปแบบไฟล์ไม่ถูกต้อง');\n            }\n            \n            wp_send_json_success(array(\n                'file_url' => $file_url,\n                'message' => 'Export Audit Log เรียบร้อย'\n            ));\n            \n        } catch (Exception $e) {\n            wp_send_json_error('เกิดข้อผิดพลาด: ' . $e->getMessage());\n        }\n    }\n    \n    /**\n     * เปรียบเทียบ versions\n     */\n    public function compare_versions() {\n        check_ajax_referer('compare_versions_nonce', 'nonce');\n        \n        if (!current_user_can('review_survey_responses')) {\n            wp_send_json_error('ไม่มีสิทธิ์ในการเปรียบเทียบ');\n        }\n        \n        $response_id = sanitize_text_field($_POST['response_id']);\n        $version1_id = intval($_POST['version1_id']);\n        $version2_id = intval($_POST['version2_id']);\n        \n        try {\n            $comparison = $this->generate_version_comparison($response_id, $version1_id, $version2_id);\n            \n            wp_send_json_success(array(\n                'comparison' => $comparison,\n                'html' => $this->render_comparison_html($comparison)\n            ));\n            \n        } catch (Exception $e) {\n            wp_send_json_error('เกิดข้อผิดพลาด: ' . $e->getMessage());\n        }\n    }\n    \n    /**\n     * Restore version\n     */\n    public function restore_version() {\n        check_ajax_referer('restore_version_nonce', 'nonce');\n        \n        if (!current_user_can('edit_survey_responses')) {\n            wp_send_json_error('ไม่มีสิทธิ์ในการ Restore');\n        }\n        \n        $response_id = sanitize_text_field($_POST['response_id']);\n        $audit_id = intval($_POST['audit_id']);\n        $restore_reason = sanitize_textarea_field($_POST['restore_reason'] ?? '');\n        \n        try {\n            $result = $this->perform_version_restore($response_id, $audit_id, $restore_reason);\n            \n            if ($result) {\n                wp_send_json_success(array(\n                    'message' => 'Restore version เรียบร้อย',\n                    'new_audit_id' => $result\n                ));\n            } else {\n                wp_send_json_error('ไม่สามารถ Restore ได้');\n            }\n            \n        } catch (Exception $e) {\n            wp_send_json_error('เกิดข้อผิดพลาด: ' . $e->getMessage());\n        }\n    }\n    \n    /**\n     * ทำความสะอาด audit logs เก่า\n     */\n    public function cleanup_old_logs() {\n        global $wpdb;\n        \n        $retention_days = apply_filters('tpak_audit_retention_days', 365); // เก็บ 1 ปี\n        \n        $audit_table = $wpdb->prefix . 'tpak_survey_audit';\n        $field_changes_table = $wpdb->prefix . 'tpak_survey_field_changes';\n        \n        // ลบ audit logs เก่า\n        $deleted_audits = $wpdb->query($wpdb->prepare(\n            \"DELETE FROM $audit_table \n             WHERE created_at < DATE_SUB(NOW(), INTERVAL %d DAY)\n               AND severity NOT IN ('high', 'critical')\",\n            $retention_days\n        ));\n        \n        // ลบ field changes ที่ไม่มี audit แล้ว\n        $deleted_changes = $wpdb->query(\n            \"DELETE fc FROM $field_changes_table fc\n             LEFT JOIN $audit_table a ON fc.audit_id = a.id\n             WHERE a.id IS NULL\"\n        );\n        \n        // บันทึก log การทำความสะอาด\n        error_log(\"TPAK Audit Cleanup: Deleted $deleted_audits audit logs and $deleted_changes field changes\");\n    }\n    \n    /**\n     * ดึงข้อมูลสำหรับ export audit\n     */\n    private function get_audit_export_data($response_id, $date_from = '', $date_to = '') {\n        global $wpdb;\n        $audit_table = $wpdb->prefix . 'tpak_survey_audit';\n        $field_changes_table = $wpdb->prefix . 'tpak_survey_field_changes';\n        \n        $where_clause = \"WHERE a.response_id = %s\";\n        $params = array($response_id);\n        \n        if ($date_from) {\n            $where_clause .= \" AND a.created_at >= %s\";\n            $params[] = $date_from;\n        }\n        \n        if ($date_to) {\n            $where_clause .= \" AND a.created_at <= %s\";\n            $params[] = $date_to . ' 23:59:59';\n        }\n        \n        $sql = \"SELECT \n                    a.*,\n                    GROUP_CONCAT(\n                        CONCAT(fc.field_name, ':', fc.old_value, '->', fc.new_value)\n                        SEPARATOR '; '\n                    ) as field_changes_summary\n                FROM $audit_table a\n                LEFT JOIN $field_changes_table fc ON a.id = fc.audit_id\n                $where_clause\n                GROUP BY a.id\n                ORDER BY a.created_at DESC\";\n        \n        return $wpdb->get_results($wpdb->prepare($sql, $params), ARRAY_A);\n    }\n    \n    /**\n     * Export audit เป็น Excel\n     */\n    private function export_audit_to_excel($audit_data, $response_id) {\n        // ใช้ PHPSpreadsheet (ต้องติดตั้งแยก)\n        $upload_dir = wp_upload_dir();\n        $file_name = 'audit_log_' . $response_id . '_' . time() . '.xlsx';\n        $file_path = $upload_dir['basedir'] . '/tpak-exports/' . $file_name;\n        \n        wp_mkdir_p($upload_dir['basedir'] . '/tpak-exports/');\n        \n        // TODO: Implement Excel generation with PHPSpreadsheet\n        // ตอนนี้สร้างไฟล์ CSV แทน\n        $csv_content = $this->generate_audit_csv_content($audit_data);\n        file_put_contents($file_path, $csv_content);\n        \n        return $upload_dir['baseurl'] . '/tpak-exports/' . $file_name;\n    }\n    \n    /**\n     * Export audit เป็น JSON\n     */\n    private function export_audit_to_json($audit_data, $response_id) {\n        $upload_dir = wp_upload_dir();\n        $file_name = 'audit_log_' . $response_id . '_' . time() . '.json';\n        $file_path = $upload_dir['basedir'] . '/tpak-exports/' . $file_name;\n        \n        wp_mkdir_p($upload_dir['basedir'] . '/tpak-exports/');\n        \n        file_put_contents($file_path, json_encode($audit_data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));\n        \n        return $upload_dir['baseurl'] . '/tpak-exports/' . $file_name;\n    }\n    \n    /**\n     * Export audit เป็น CSV\n     */\n    private function export_audit_to_csv($audit_data, $response_id) {\n        $upload_dir = wp_upload_dir();\n        $file_name = 'audit_log_' . $response_id . '_' . time() . '.csv';\n        $file_path = $upload_dir['basedir'] . '/tpak-exports/' . $file_name;\n        \n        wp_mkdir_p($upload_dir['basedir'] . '/tpak-exports/');\n        \n        $csv_content = $this->generate_audit_csv_content($audit_data);\n        file_put_contents($file_path, $csv_content);\n        \n        return $upload_dir['baseurl'] . '/tpak-exports/' . $file_name;\n    }\n    \n    /**\n     * สร้างเนื้อหา CSV\n     */\n    private function generate_audit_csv_content($audit_data) {\n        $csv = \"วันที่/เวลา,การกระทำ,ผู้ใช้,บทบาท,IP Address,รายละเอียด,ความสำคัญ,สถานะ\\n\";\n        \n        foreach ($audit_data as $row) {\n            $csv .= sprintf(\n                \"%s,%s,%s,%s,%s,\\\"%s\\\",%s,%s\\n\",\n                $row['created_at'],\n                $row['action'],\n                $row['user_name'],\n                $row['user_role'],\n                $row['ip_address'],\n                str_replace('\"', '\"\"', $row['field_changes_summary'] ?? ''),\n                $row['severity'],\n                $row['status']\n            );\n        }\n        \n        return \"\\xEF\\xBB\\xBF\" . $csv; // เพิ่ม BOM สำหรับ UTF-8\n    }\n    \n    /**\n     * สร้างการเปรียบเทียบ versions\n     */\n    private function generate_version_comparison($response_id, $version1_id, $version2_id) {\n        global $wpdb;\n        $audit_table = $wpdb->prefix . 'tpak_survey_audit';\n        \n        $version1 = $wpdb->get_row($wpdb->prepare(\n            \"SELECT * FROM $audit_table WHERE id = %d AND response_id = %s\",\n            $version1_id, $response_id\n        ), ARRAY_A);\n        \n        $version2 = $wpdb->get_row($wpdb->prepare(\n            \"SELECT * FROM $audit_table WHERE id = %d AND response_id = %s\",\n            $version2_id, $response_id\n        ), ARRAY_A);\n        \n        if (!$version1 || !$version2) {\n            throw new Exception('ไม่พบ version ที่ระบุ');\n        }\n        \n        $data1 = json_decode($version1['after_data'], true) ?? array();\n        $data2 = json_decode($version2['after_data'], true) ?? array();\n        \n        $differences = array();\n        $all_fields = array_unique(array_merge(array_keys($data1), array_keys($data2)));\n        \n        foreach ($all_fields as $field) {\n            $value1 = $data1[$field] ?? null;\n            $value2 = $data2[$field] ?? null;\n            \n            if ($value1 !== $value2) {\n                $differences[$field] = array(\n                    'field' => $field,\n                    'version1_value' => $value1,\n                    'version2_value' => $value2,\n                    'change_type' => $this->determine_change_type($value1, $value2)\n                );\n            }\n        }\n        \n        return array(\n            'version1' => $version1,\n            'version2' => $version2,\n            'differences' => $differences\n        );\n    }\n    \n    /**\n     * Render HTML การเปรียบเทียบ\n     */\n    private function render_comparison_html($comparison) {\n        $html = '<div class=\"version-comparison\">';\n        \n        $html .= '<div class=\"comparison-header\">';\n        $html .= '<div class=\"version-info\">';\n        $html .= '<h4>Version 1</h4>';\n        $html .= '<p>วันที่: ' . esc_html($comparison['version1']['created_at']) . '</p>';\n        $html .= '<p>ผู้แก้ไข: ' . esc_html($comparison['version1']['user_name']) . '</p>';\n        $html .= '</div>';\n        \n        $html .= '<div class=\"version-info\">';\n        $html .= '<h4>Version 2</h4>';\n        $html .= '<p>วันที่: ' . esc_html($comparison['version2']['created_at']) . '</p>';\n        $html .= '<p>ผู้แก้ไข: ' . esc_html($comparison['version2']['user_name']) . '</p>';\n        $html .= '</div>';\n        $html .= '</div>';\n        \n        if (empty($comparison['differences'])) {\n            $html .= '<p>ไม่มีความแตกต่าง</p>';\n        } else {\n            $html .= '<div class=\"differences\">';\n            $html .= '<h4>ความแตกต่าง (' . count($comparison['differences']) . ' รายการ)</h4>';\n            \n            foreach ($comparison['differences'] as $diff) {\n                $html .= '<div class=\"diff-item\">';\n                $html .= '<strong>' . esc_html($diff['field']) . '</strong>';\n                $html .= '<div class=\"diff-values\">';\n                $html .= '<div class=\"old-value\">เก่า: ' . esc_html($diff['version1_value']) . '</div>';\n                $html .= '<div class=\"new-value\">ใหม่: ' . esc_html($diff['version2_value']) . '</div>';\n                $html .= '</div>';\n                $html .= '</div>';\n            }\n            \n            $html .= '</div>';\n        }\n        \n        $html .= '</div>';\n        \n        return $html;\n    }\n    \n    /**\n     * ทำการ restore version\n     */\n    private function perform_version_restore($response_id, $audit_id, $restore_reason) {\n        global $wpdb;\n        $audit_table = $wpdb->prefix . 'tpak_survey_audit';\n        $responses_table = $wpdb->prefix . 'tpak_survey_responses';\n        \n        // ดึงข้อมูลจาก audit ที่จะ restore\n        $restore_audit = $wpdb->get_row($wpdb->prepare(\n            \"SELECT * FROM $audit_table WHERE id = %d AND response_id = %s\",\n            $audit_id, $response_id\n        ), ARRAY_A);\n        \n        if (!$restore_audit) {\n            throw new Exception('ไม่พบข้อมูล audit ที่จะ restore');\n        }\n        \n        $restore_data = json_decode($restore_audit['after_data'], true);\n        \n        if (!$restore_data) {\n            throw new Exception('ไม่มีข้อมูลสำหรับ restore');\n        }\n        \n        // ดึงข้อมูลปัจจุบัน\n        $current_data = $wpdb->get_row($wpdb->prepare(\n            \"SELECT * FROM $responses_table WHERE response_id = %s\",\n            $response_id\n        ), ARRAY_A);\n        \n        if (!$current_data) {\n            throw new Exception('ไม่พบข้อมูลปัจจุบัน');\n        }\n        \n        $current_response_data = json_decode($current_data['response_data'], true);\n        \n        // อัปเดตข้อมูล\n        $new_response_data = $current_response_data;\n        $new_response_data['responses'] = $restore_data;\n        \n        $result = $wpdb->update(\n            $responses_table,\n            array(\n                'response_data' => json_encode($new_response_data),\n                'updated_at' => current_time('mysql')\n            ),\n            array('response_id' => $response_id)\n        );\n        \n        if ($result !== false) {\n            // บันทึก audit log การ restore\n            return $this->log_audit($response_id, 'restored', array(\n                'restored_from_audit_id' => $audit_id,\n                'restore_reason' => $restore_reason,\n                'before_data' => $current_response_data['responses'],\n                'after_data' => $restore_data\n            ));\n        }\n        \n        return false;\n    }\n    \n    /**\n     * ดึงหรือสร้าง session ID\n     */\n    private function get_or_create_session() {\n        $session_id = session_id();\n        \n        if (empty($session_id)) {\n            if (!session_start()) {\n                session_start();\n            }\n            $session_id = session_id();\n        }\n        \n        // บันทึก session ลงฐานข้อมูล\n        $this->track_user_session($session_id);\n        \n        return $session_id;\n    }\n    \n    /**\n     * ติดตาม user session\n     */\n    private function track_user_session($session_id) {\n        global $wpdb;\n        $sessions_table = $wpdb->prefix . 'tpak_user_sessions';\n        $current_user = wp_get_current_user();\n        \n        // ตรวจสอบว่ามี session อยู่แล้วหรือไม่\n        $existing = $wpdb->get_row($wpdb->prepare(\n            \"SELECT * FROM $sessions_table WHERE session_id = %s\",\n            $session_id\n        ));\n        \n        if (!$existing) {\n            // สร้าง session ใหม่\n            $wpdb->insert(\n                $sessions_table,\n                array(\n                    'session_id' => $session_id,\n                    'user_id' => $current_user->ID,\n                    'login_time' => current_time('mysql'),\n                    'ip_address' => $this->get_client_ip(),\n                    'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? '',\n                    'is_active' => 1\n                )\n            );\n        } else {\n            // อัปเดต last activity\n            $wpdb->update(\n                $sessions_table,\n                array(\n                    'last_activity' => current_time('mysql'),\n                    'is_active' => 1\n                ),\n                array('session_id' => $session_id)\n            );\n        }\n    }\n    \n    /**\n     * อัปเดต session activity\n     */\n    private function update_session_activity($session_id) {\n        global $wpdb;\n        $sessions_table = $wpdb->prefix . 'tpak_user_sessions';\n        \n        $wpdb->update(\n            $sessions_table,\n            array('last_activity' => current_time('mysql')),\n            array('session_id' => $session_id)\n        );\n    }\n    \n    /**\n     * กำหนดความสำคัญของ action\n     */\n    private function get_action_severity($action) {\n        $severity_map = array(\n            'save_draft' => 'low',\n            'submit' => 'medium',\n            'reviewed' => 'medium',\n            'approved' => 'high',\n            'rejected' => 'high',\n            'restored' => 'critical',\n            'deleted' => 'critical',\n            'exported' => 'low',\n            'forwarded' => 'medium'\n        );\n        \n        return $severity_map[$action] ?? 'low';\n    }\n    \n    /**\n     * กำหนดประเภทการเปลี่ยนแปลง\n     */\n    private function determine_change_type($old_value, $new_value) {\n        if ($old_value === null || $old_value === '') {\n            return 'created';\n        } elseif ($new_value === null || $new_value === '') {\n            return 'deleted';\n        } else {\n            return 'updated';\n        }\n    }\n    \n    /**\n     * ดึง IP address ของ client\n     */\n    private function get_client_ip() {\n        $ip = '';\n        \n        if (isset($_SERVER['HTTP_X_FORWARDED_FOR']) && !empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {\n            $ip = $_SERVER['HTTP_X_FORWARDED_FOR'];\n        } elseif (isset($_SERVER['HTTP_X_REAL_IP']) && !empty($_SERVER['HTTP_X_REAL_IP'])) {\n            $ip = $_SERVER['HTTP_X_REAL_IP'];\n        } elseif (isset($_SERVER['REMOTE_ADDR'])) {\n            $ip = $_SERVER['REMOTE_ADDR'];\n        }\n        \n        // ถ้ามีหลาย IP (proxy chain) เอาตัวแรก\n        if (strpos($ip, ',') !== false) {\n            $ip = trim(explode(',', $ip)[0]);\n        }\n        \n        return $ip;\n    }\n}